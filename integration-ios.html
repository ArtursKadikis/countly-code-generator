<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="icon" href="favicon.ico">

        <title>Countly Code Generator</title>

        <!-- Bootstrap core CSS -->
        <link href="css/bootstrap.min.css" rel="stylesheet">

        <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
        <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">
    
        <!-- Custom styles for this template -->
        <link href="css/style.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="jumbotron top">
            <div class="container">
                <div id="logo">
                    <span class="image"></span>
                    <span class="text">Code Generator</span>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div style="overflow: auto">
                        <div class="btn-group" style="float: left">
                            <a href="integration.html" id="back" class="btn btn-default">&larr; Back</a>
                            <a href="events.html?sdk=ios" id="next" class="btn btn-default">Next: Create Event &rarr;</a>
                        </div>
                        <div id="buttons" class="btn-group" role="group" style="float: right">

                        </div>
                    </div>
                    <h2 class="text-center">Integrating Apple SDK (iOS, OSX, tvOS, WatchOS)</h2>
                </div>
            </div>
            <div class='section configuration'>
                <span class='label'>Provide configuration settings</span>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for='server-url'>Server URL:</label>
                            <input type="url" class="form-control" id='server-url' placeholder="https://cloud.count.ly">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="app_key">App Key:</label>
                            <input type="text" class="form-control" id="app_key" placeholder="f399aa0a6305c2bd51d304ca666418ae8d93d9bc">
                        </div>
                    </div>
                </div>
            </div>



            <div class='section platform radio'>
                <span class='label'>Choose which platform you want to use</span>
                <div class="row">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='platform' value='iOS' checked="checked"> iOS
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='platform' value='watchOS'> watchOS
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='platform' value='tvOS'> tvOS
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='platform' value='OSX'> OSX
                        </label>
                    </div>
                </div>
            </div>



            <div class='section device_id radio'>
                <span class='label'>Choose the way to generate device ID</span>
                <div class="row" id="device_id_CLYSDKDefault">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='device_id' value='CLYSDKDefault'><span id="device_id_sdk_default_text"> SDK Default (IDFA)</span>
                        </label>
                    </div>
                </div>
                <div class="row" id="device_id_CLYIDFV">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='device_id' value='CLYIDFV'> Identifier for Vendor (IDFV)
                        </label>
                    </div>
                </div>
                <div class="row" id="device_id_CLYOpenUDID">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='device_id' value='CLYOpenUDID'> OpenUDID
                        </label>
                    </div>
                </div>

                <div class="row" id="device_id_Custom">
                    <div class="col-md-12">
                        <label>
                            <input type="radio" name='device_id' value='CLYCustom'> Custom
                            <input type="text" class="form-control" id="custom_devide_id" placeholder="uid1234@myapp" disabled=true>
                        </label>
                    </div>
                </div>
            </div>



            <div class='section features checkbox'>
                <span class='label'>Choose optional features you want to use</span>
                <div class="row" id="feature_CLYMessaging">
                    <div class="col-md-12">
                        <label>
                            <input type="checkbox" class='feature' value='CLYMessaging'> Push Notifications
                        </label>
                    </div>
                </div>
                <div class="row" id="feature_CLYCrashReporting">
                    <div class="col-md-12">
                        <label>
                            <input type="checkbox" class='feature' value='CLYCrashReporting'> Crash Reporting
                        </label>
                    </div>
                </div>
                <div class="row" id="feature_CLYAPM">
                    <div class="col-md-12">
                        <label>
                            <input type="checkbox" class='feature' value='CLYAPM'> APM
                        </label>
                    </div>
                </div>
                <div class="row" id="feature_CLYViewTracking">
                    <div class="col-md-12">
                        <label>
                            <input type="checkbox" class='feature' value='CLYViewTracking'> Auto View Tracking
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p>&nbsp;</p>
                    </div><!-- /.col-lg-6 -->
                </div><!-- /.row -->
                <div class="row">
                    <div class="col-md-12">
                        <label>
                            <input type="checkbox" id="allfeatures"> I want all features
                        </label>
                    </div><!-- /.col-lg-6 -->
                </div><!-- /.row -->
            </div>



            <div class="row">
                <div class="col-md-12">
                    <p class='text-center'><button type="button" class="btn btn-success" id="generate">Generate code</button></p>
                </div>
            </div>

            <footer>
                <p><a href='http://count.ly'>Count.ly</a></p>
            </footer>
        </div> <!-- /container -->
    
        <div class="modal fade" id="end-modal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Integrate <span class='integrate ios'>iOS</span><span class='integrate tvos'>tvOS</span><span class='integrate osx'>OSX</span><span class='integrate watchos'>WatchOS</span> SDK</h4>
                </div>
                <div class="modal-body">
                    <p>Insert this snippet to in your application delegate, or modify it to include provided code in same methods</p>
                    <p id='push' class='well'><a href="http://resources.count.ly/docs/countly-sdk-for-ios-and-os-x#setting-up-push-notifications" target="_blank">More information on setting up push notifications on server</a></p>
                    <p><textarea id='end-code' readonly onclick="this.select();"></textarea></p>
                    <p class='text-center'>
                        <button type="button" class="btn btn-success" id="copy" data-clipboard-target="#end-code">Copy</button>&nbsp;
                        <button type="button" class="btn btn-success" id="download">Download</button>&nbsp;
                        <button type="button" class="btn btn-primary" id="gotit">Close</button>
                    </p>
                </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')</script>
        <script src="js/bootstrap.min.js"></script>
        <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
        <script src="js/ie10-viewport-bug-workaround.js"></script>
        <script src="js/sdks.js"></script>
        <script src="js/common.js"></script>
        <script src="js/Blob.js"></script>
        <script src="js/FileSaver.min.js"></script>
        <script src="js/clipboard.min.js"></script>
        <script>
        $( document ).ready(function()
        {
            new Clipboard('#copy');
            var sdk = sdks.ios;
            $("#buttons").append('<a href="'+sdk.docs+'" target="_blank" class="btn btn-default">Documentation</a>');
            $("#buttons").append('<a href="'+sdk.download+'" target="_blank" class="btn btn-default">Download</a>');
            $("#buttons").append('<a href="'+sdk.repo+'" target="_blank" class="btn btn-default">Repository</a>');
            
            var params = parseParams(location.search);
            if(params.server)
            {
                $("#server-url").val(params.server);
            }
            
            if(params.app_key)
            {
                $("#app_key").val(params.app_key);
            }
            
            if(params.server && params.app_key)
            {
                $(".configuration").hide();
            }
            
            var template = "#import \"Countly.h\"\n"+
                "\n"+
                "- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions\n"+
                "{\n"+
                "   CountlyConfig* config = CountlyConfig.new;\n"+
                "   config.appKey = @\"YOUR_APP_KEY\";\n"+
                "   config.host = @\"https://YOUR_COUNTLY_SERVER\";\n"+
                "   config.deviceID = CLYIDFA;\n"+
                "   //You can specify optional features you want here\n"+
                "   [features]\n"+
                "   [Countly.sharedInstance startWithConfig:config];\n"+
                "   \n"+
                "   // your code\n"+
                "}";
                
             var pushHandling = 
                "   if ([application respondsToSelector:@selector(registerUserNotificationSettings:)])\n"+
                "   {\n"+
                "       UIUserNotificationType userNotificationTypes = UIUserNotificationTypeAlert | UIUserNotificationTypeBadge | UIUserNotificationTypeSound;\n"+
                "       UIUserNotificationSettings* notificationSettings = [UIUserNotificationSettings settingsForTypes:userNotificationTypes categories:[Countly.sharedInstance countlyNotificationCategories]];\n"+
                "       [UIApplication.sharedApplication registerUserNotificationSettings:notificationSettings];\n"+
                "   }\n"+
                "   else\n"+
                "   {\n"+
                "       [UIApplication.sharedApplication registerForRemoteNotificationTypes: (UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeSound | UIRemoteNotificationTypeAlert)];\n"+
                "   }\n";
                
            var pushMethods = "\n- (void)application:(UIApplication *)application didRegisterUserNotificationSettings:(UIUserNotificationSettings *)notificationSettings {\n"+
                "   [application registerForRemoteNotifications];\n"+
                "}\n"+
                "\n"+
                "- (void) application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken {\n"+
                "   [Countly.sharedInstance didRegisterForRemoteNotificationsWithDeviceToken:deviceToken];\n"+
                "}\n"+
                "\n"+
                "- (void) application:(UIApplication *)application didFailToRegisterForRemoteNotificationsWithError:(NSError *)error {\n"+
                "   [Countly.sharedInstance didFailToRegisterForRemoteNotifications];\n"+
                "}\n"+
                "\n"+
                "- (void) application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler {\n"+
                "   [Countly.sharedInstance handleRemoteNotification:userInfo];\n"+
                "}\n";
                
            $("#generate").click(function()
            {
                $( ".alert" ).remove();
                $(".integrate").hide();
                var data = {};
                data.url = $("#server-url").val();
                
                if(data.url == "")
                {
                    $("#server-url").parent().prepend('<div class="alert alert-danger" role="alert">Please provide server URL</div>');
                    return;
                }
                
                if(data.url.indexOf("http") != 0)
                {
                    $("#server-url").parent().prepend('<div class="alert alert-danger" role="alert">Your server URL should start with http:// or https://</div>');
                    return;
                }
                
                if(data.url.indexOf("https") != 0)
                {
                    $("#end-modal .modal-body #push").after('<div class="alert alert-warning" role="alert"><strong>Note:</strong> Your server does not use secure https. It means that for iOS 9+ versions you need to add <strong>NSAppTransportSecurity</strong> key into your applications info.plist file, with one of the following values: <strong>NSAllowsArbitraryLoads</strong> or <strong>NSExceptionDomains</strong> to communicate with server (<a href="https://developer.apple.com/library/prerelease/ios/releasenotes/General/WhatsNewIniOS/Articles/iOS9.html#//apple_ref/doc/uid/TP40016198-SW14" target="_blank">More information</a>)</div>');
                }
                    
                data.app_key = $("#app_key").val();
                
                if(data.app_key == "")
                {
                    $("#app_key").parent().prepend('<div class="alert alert-danger" role="alert">Please provide App Key</div>');
                    return;
                }

                data.platform = $("input:radio[name=platform]:checked").val();
                    
                if(!data.platform || data.platform == "")
                {
                    $(".platform").prepend('<div class="alert alert-danger" role="alert">Please select platform</div>');
                    return;
                }

                $(".integrate."+data.platform.toLowerCase()).show();

                data.device_id = $("input:radio[name=device_id]:checked").val();
                    
                if(!data.device_id || data.device_id == "")
                {
                    $(".device_id").prepend('<div class="alert alert-danger" role="alert">Please select at least way to generate device Id</div>');
                    return;
                }
                
                var features = $(".feature:checked:visible").map(function(feature)
                {
                    return this.value;
                }).get();
                
                if(features.length)
                {
                    data.features = "config.features = @["+features.join(", ")+"];\n";
                    if(features.indexOf("CLYMessaging") > -1)
                    {
                        data.features += "   config.launchOptions = launchOptions;\n";
                    }
                    else
                    {
                        $("#push").hide();
                    }
                }
                else
                {
                    data.features = "";
                }
                
                var code = template.replace("https://YOUR_COUNTLY_SERVER", data.url)
                    .replace("YOUR_APP_KEY", data.app_key)
                    .replace("[features]", data.features);
                

                if(data.device_id == "CLYSDKDefault")
                {
                    code = code.replace("   config.deviceID = CLYIDFA;\n", "");
                }
                else if (data.device_id == "CLYCustom")
                {
                    code = code.replace("CLYIDFA", $('#custom_devide_id').val());
                }
                else
                {
                    code = code.replace("CLYIDFA", data.device_id)
                }

                if(features.length == 0)
                {
                    code = code.replace("   //You can specify optional features you want here\n", "");
                }

                if(features.indexOf("CLYMessaging") > -1)
                {
                    code = code.replace("   // your code\n", pushHandling);
                    code += "\n"+pushMethods;
                }

                $("#end-code").val(code);
                $('#end-modal').modal();
            });
            
            $("#allfeatures").change(function(){
                $(".feature").prop('checked', $(this).prop("checked"));
                if ($(this).is(':checked')) {
                    $(".push-settings").removeClass("hidden");
                } else {
                    $(".push-settings").addClass("hidden");
                }
            });
        
            $("#gotit").click(function()
            {
                $('#end-modal').modal('hide');
            });
            
            $("#download").click(function()
            {
                var data = $("#end-code").val();
                try {
                    var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
                    saveAs(blob, "web-sdk.txt");
                } catch (e) {
                    alert(data);
                }
            });
            
            
            $('input:radio[name=platform]').change( function()
            {
                $('input:radio[name=device_id]').removeAttr('checked');
                $("#device_id_sdk_default_text").text("SDK Default");
                $('#custom_devide_id').prop('disabled',true);
                $('#custom_devide_id').val('');

                $('#feature_CLYMessaging').hide();
                $('#feature_CLYCrashReporting').hide();
                $('#feature_CLYViewTracking').hide();

                platform = $("input:radio[name=platform]:checked").val();                
                if(platform == 'iOS')
                {
                    $('#device_id_CLYIDFV').show();
                    $('#device_id_CLYOpenUDID').show();
                    $("#device_id_sdk_default_text").text("SDK Default (IDFA)");

                    $('#feature_CLYMessaging').show();
                    $('#feature_CLYCrashReporting').show();
                    $('#feature_CLYViewTracking').show();
                }
                else if(platform == 'watchOS')
                {
                    $('#device_id_CLYIDFV').hide();
                    $('#device_id_CLYOpenUDID').hide();
                }
                else if(platform == 'tvOS')
                {
                    $('#device_id_CLYIDFV').hide();
                    $('#device_id_CLYOpenUDID').hide();
                }
                else if(platform == 'OSX')
                {
                    $('#device_id_CLYIDFV').hide();
                    $('#device_id_CLYOpenUDID').show();
                }
            });


            $('input:radio[name=device_id]').change( function()
            {
                device_id = $("input:radio[name=device_id]:checked").val();

                if(device_id == 'CLYCustom')
                {
                    $('#custom_devide_id').prop('disabled',false);
                }
                else
                {
                    $('#custom_devide_id').prop('disabled',true);
                    $('#custom_devide_id').val('');
                }
            });            
        });
        </script>
    </body>
</html>
